<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Military Roster Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const RANKS = [
            'PVT', 'PFC', 'LCPL', 'CPL', 'SGT', 'SSGT', 'GYSGT', 'MSGT', 'MGYSGT', 
            'SMMC', 'WO', '2ndLT', '1stLT', 'CPT', 'MAJ', 'LTCOL', 'COL', 'XO', 
            'COMMANDER', 'BGEN', 'MAJGEN', 'LTGEN'
        ];

        // Icons
        const ChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"></polyline></svg>;
        const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const RefreshCw = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const Lock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>;
        const AlertCircle = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const Edit2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
        const Save = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const LogIn = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>;
        const LogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;

        function RosterApp() {
            const [isConfigured, setIsConfigured] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [config, setConfig] = useState({
                baseId: 'apppTIfE6NtJusdjj',
                rosterTableName: 'Roster',
                usersTableName: 'Users',
                apiToken: ''
            });
            const [roster, setRoster] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [editingRecord, setEditingRecord] = useState(null);
            const [editForm, setEditForm] = useState({});

            const saveConfig = () => {
                if (!config.baseId || !config.apiToken) {
                    setError('Please fill in Base ID and API Token');
                    return;
                }
                localStorage.setItem('rosterConfig', JSON.stringify(config));
                setIsConfigured(true);
                setError('');
                fetchRoster();
            };

            const loadConfig = () => {
                const saved = localStorage.getItem('rosterConfig');
                if (saved) {
                    setConfig(JSON.parse(saved));
                    setIsConfigured(true);
                    return true;
                }
                return false;
            };

            const getRankIndex = (rank) => RANKS.indexOf(rank);
            const canPromote = (userRank) => getRankIndex(userRank) >= getRankIndex('WO');
            const canDemote = (userRank) => getRankIndex(userRank) >= getRankIndex('MAJ');
            const canEdit = (userRank) => getRankIndex(userRank) >= getRankIndex('MAJ');

            const handleLogin = async () => {
                if (!username || !password) {
                    setError('Please enter username and password');
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    const response = await fetch(
                        `https://api.airtable.com/v0/${config.baseId}/${encodeURIComponent(config.usersTableName)}?filterByFormula=AND({Username}='${username}',{Password}='${password}')`,
                        { headers: { 'Authorization': `Bearer ${config.apiToken}` } }
                    );
                    if (!response.ok) throw new Error('Authentication failed');
                    const data = await response.json();
                    if (data.records && data.records.length > 0) {
                        const user = data.records[0];
                        setCurrentUser({
                            id: user.id,
                            username: user.fields.Username,
                            rank: user.fields.Rank,
                            name: user.fields.Name || user.fields.Username
                        });
                        setIsAuthenticated(true);
                        setUsername('');
                        setPassword('');
                        setShowLoginModal(false);
                        setSuccess('Login successful!');
                        setTimeout(() => setSuccess(''), 3000);
                    } else {
                        setError('Invalid username or password');
                    }
                } catch (err) {
                    setError(`Login error: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const fetchRoster = async () => {
                setLoading(true);
                setError('');
                try {
                    const response = await fetch(
                        `https://api.airtable.com/v0/${config.baseId}/${encodeURIComponent(config.rosterTableName)}`,
                        { headers: { 'Authorization': `Bearer ${config.apiToken}` } }
                    );
                    if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);
                    const data = await response.json();
                    setRoster(data.records || []);
                } catch (err) {
                    setError(`Error fetching roster: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const requireAuth = () => {
                if (!isAuthenticated) {
                    setShowLoginModal(true);
                    setError('Please login to perform this action');
                    return false;
                }
                return true;
            };

            const promoteUser = async (recordId, currentRank, name) => {
                if (!requireAuth() || !canPromote(currentUser.rank)) {
                    setError('You do not have permission to promote');
                    return;
                }
                const currentIndex = RANKS.indexOf(currentRank);
                if (currentIndex === -1 || currentIndex === RANKS.length - 1) {
                    setError(`Cannot promote ${name}`);
                    return;
                }
                const newRank = RANKS[currentIndex + 1];
                await updateRank(recordId, newRank, name, 'promoted');
            };

            const demoteUser = async (recordId, currentRank, name) => {
                if (!requireAuth() || !canDemote(currentUser.rank)) {
                    setError('You do not have permission to demote (requires MAJ+)');
                    return;
                }
                const currentIndex = RANKS.indexOf(currentRank);
                if (currentIndex === -1 || currentIndex === 0) {
                    setError(`Cannot demote ${name}`);
                    return;
                }
                const newRank = RANKS[currentIndex - 1];
                await updateRank(recordId, newRank, name, 'demoted');
            };

            const updateRank = async (recordId, newRank, name, action) => {
                setLoading(true);
                setError('');
                setSuccess('');
                try {
                    const response = await fetch(
                        `https://api.airtable.com/v0/${config.baseId}/${encodeURIComponent(config.rosterTableName)}/${recordId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${config.apiToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ fields: { 'Rank': newRank } })
                        }
                    );
                    if (!response.ok) throw new Error(`Failed to update: ${response.status}`);
                    setSuccess(`‚úì ${name} ${action} to ${newRank}!`);
                    setTimeout(() => setSuccess(''), 3000);
                    await fetchRoster();
                } catch (err) {
                    setError(`Error: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const startEdit = (record) => {
                if (!requireAuth() || !canEdit(currentUser.rank)) {
                    setError('You do not have permission to edit records (requires MAJ+)');
                    return;
                }
                setEditingRecord(record.id);
                setEditForm(record.fields);
            };

            const cancelEdit = () => {
                setEditingRecord(null);
                setEditForm({});
            };

            const saveEdit = async (recordId) => {
                setLoading(true);
                setError('');
                setSuccess('');
                try {
                    const response = await fetch(
                        `https://api.airtable.com/v0/${config.baseId}/${encodeURIComponent(config.rosterTableName)}/${recordId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${config.apiToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ fields: editForm })
                        }
                    );
                    if (!response.ok) throw new Error(`Failed to save: ${response.status}`);
                    setSuccess('‚úì Record updated successfully!');
                    setTimeout(() => setSuccess(''), 3000);
                    setEditingRecord(null);
                    setEditForm({});
                    await fetchRoster();
                } catch (err) {
                    setError(`Error saving: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                const configured = loadConfig();
                if (configured) fetchRoster();
            }, []);

            if (!isConfigured) {
                return (
                    <div className="min-h-screen bg-slate-900 text-white p-8">
                        <div className="max-w-2xl mx-auto">
                            <div className="bg-slate-800 rounded-lg p-8 shadow-xl border border-slate-700">
                                <h1 className="text-3xl font-bold mb-6 text-center">üéñÔ∏è Roster Setup</h1>
                                <div className="mb-6 bg-blue-900/30 border border-blue-700 rounded p-4 text-sm">
                                    <p className="font-semibold mb-2">üìã Required: Users table in Airtable</p>
                                    <p className="mb-2">Fields: Username, Password, Rank, Name (optional)</p>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Airtable Base ID</label>
                                        <input type="text" placeholder="app..." value={config.baseId} onChange={(e) => setConfig({...config, baseId: e.target.value})} className="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none text-white" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Roster Table Name</label>
                                        <input type="text" value={config.rosterTableName} onChange={(e) => setConfig({...config, rosterTableName: e.target.value})} className="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none text-white" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Users Table Name</label>
                                        <input type="text" value={config.usersTableName} onChange={(e) => setConfig({...config, usersTableName: e.target.value})} className="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none text-white" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Personal Access Token</label>
                                        <input type="password" placeholder="pat..." value={config.apiToken} onChange={(e) => setConfig({...config, apiToken: e.target.value})} className="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none text-white" />
                                    </div>
                                    {error && <div className="bg-red-900/50 border border-red-700 rounded p-3 text-sm">{error}</div>}
                                    <button onClick={saveConfig} className="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded font-medium transition">Save Configuration</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const userCanPromote = isAuthenticated && canPromote(currentUser.rank);
            const userCanDemote = isAuthenticated && canDemote(currentUser.rank);
            const userCanEdit = isAuthenticated && canEdit(currentUser.rank);

            return (
                <div className="min-h-screen bg-slate-900 text-white p-4 md:p-8">
                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 rounded-lg p-8 shadow-xl border border-slate-700 w-full max-w-md">
                                <div className="flex justify-center mb-6 text-blue-500"><Lock /></div>
                                <h2 className="text-2xl font-bold mb-6 text-center">Login Required</h2>
                                <div className="space-y-4">
                                    <input type="text" placeholder="Username" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full px-4 py-3 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none text-white" />
                                    <input type="password" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleLogin()} className="w-full px-4 py-3 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none text-white" />
                                    {error && <div className="bg-red-900/50 border border-red-700 rounded p-3 text-sm flex items-start gap-2"><AlertCircle className="flex-shrink-0 mt-0.5" /><span>{error}</span></div>}
                                    <button onClick={handleLogin} disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded font-medium transition disabled:opacity-50">{loading ? 'Logging in...' : 'Login'}</button>
                                    <button onClick={() => { setShowLoginModal(false); setError(''); setUsername(''); setPassword(''); }} className="w-full text-slate-400 hover:text-white text-sm transition">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-7xl mx-auto">
                        <div className="bg-slate-800 rounded-lg shadow-xl border border-slate-700">
                            <div className="p-6 border-b border-slate-700 flex items-center justify-between flex-wrap gap-4">
                                <div>
                                    <h1 className="text-3xl font-bold">üéñÔ∏è Military Roster</h1>
                                    {isAuthenticated && <p className="text-sm text-slate-400 mt-1">Logged in as <span className="text-blue-400 font-medium">{currentUser.name}</span> ({currentUser.rank})</p>}
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={fetchRoster} disabled={loading} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition disabled:opacity-50">
                                        <RefreshCw className={loading ? 'animate-spin' : ''} />
                                        Refresh
                                    </button>
                                    {isAuthenticated ? (
                                        <button onClick={() => { setIsAuthenticated(false); setCurrentUser(null); setSuccess('Logged out'); setTimeout(() => setSuccess(''), 3000); }} className="flex items-center gap-2 bg-slate-600 hover:bg-slate-700 px-4 py-2 rounded transition">
                                            <LogOut />Logout
                                        </button>
                                    ) : (
                                        <button onClick={() => setShowLoginModal(true)} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded transition">
                                            <LogIn />Login
                                        </button>
                                    )}
                                </div>
                            </div>

                            {isAuthenticated && (
                                <div className="p-6 border-b border-slate-700 bg-slate-750">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                        <div className="flex items-center gap-2"><span className={userCanPromote ? 'text-green-400' : 'text-slate-500'}>{userCanPromote ? '‚úì' : '‚úó'}</span><span>Can Promote (WO+)</span></div>
                                        <div className="flex items-center gap-2"><span className={userCanDemote ? 'text-green-400' : 'text-slate-500'}>{userCanDemote ? '‚úì' : '‚úó'}</span><span>Can Demote (MAJ+)</span></div>
                                        <div className="flex items-center gap-2"><span className={userCanEdit ? 'text-green-400' : 'text-slate-500'}>{userCanEdit ? '‚úì' : '‚úó'}</span><span>Can Edit Records (MAJ+)</span></div>
                                    </div>
                                </div>
                            )}

                            {error && !showLoginModal && <div className="m-6 bg-red-900/50 border border-red-700 rounded p-4 flex items-start gap-2"><AlertCircle className="flex-shrink-0 mt-0.5" /><span>{error}</span></div>}
                            {success && <div className="m-6 bg-green-900/50 border border-green-700 rounded p-4">{success}</div>}

                            <div className="p-6">
                                {loading && roster.length === 0 ? (
                                    <div className="text-center py-12 text-slate-400"><RefreshCw className="w-8 h-8 animate-spin mx-auto mb-2" /><p>Loading roster...</p></div>
                                ) : roster.length === 0 ? (
                                    <div className="text-center py-12 text-slate-400">No roster data found.</div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="border-b border-slate-700">
                                                    <th className="text-left py-3 px-4">Name</th>
                                                    <th className="text-left py-3 px-4">Rank</th>
                                                    <th className="text-left py-3 px-4">SteamID</th>
                                                    <th className="text-left py-3 px-4">Last Promoted</th>
                                                    {isAuthenticated && <th className="text-center py-3 px-4">Actions</th>}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {roster.map((record) => {
                                                    const name = record.fields.Name || record.fields.Username || 'Unknown';
                                                    const currentRank = record.fields.Rank || 'N/A';
                                                    const steamID = record.fields.SteamID || '-';
                                                    const lastPromoted = record.fields['Last Promoted'] ? new Date(record.fields['Last Promoted Date']).toLocaleDateString() : '-';
                                                    const currentIndex = RANKS.indexOf(currentRank);
                                                    const isEditing = editingRecord === record.id;
                                                    
                                                    return (
                                                        <tr key={record.id} className="border-b border-slate-700 hover:bg-slate-750">
                                                            <td className="py-3 px-4 font-medium">
                                                                {isEditing ? <input type="text" value={editForm.Name || editForm.Username || ''} onChange={(e) => setEditForm({...editForm, Name: e.target.value})} className="bg-slate-700 px-2 py-1 rounded border border-slate-600 w-full text-white" /> : name}
                                                            </td>
                                                            <td className="py-3 px-4">
                                                                {isEditing ? (
                                                                    <select value={editForm.Rank} onChange={(e) => setEditForm({...editForm, Rank: e.target.value})} className="bg-slate-700 px-2 py-1 rounded border border-slate-600 text-white">
                                                                        {RANKS.map(rank => <option key={rank} value={rank}>{rank}</option>)}
                                                                    </select>
                                                                ) : (
                                                                    <span className="bg-blue-900/50 text-blue-300 px-3 py-1 rounded text-sm font-mono">{currentRank}</span>
                                                                )}
                                                            </td>
                                                            <td className="py-3 px-4 text-slate-300">
                                                                {isEditing ? <input type="text" value={editForm.SteamID || ''} onChange={(e) => setEditForm({...editForm, SteamID: e.target.value})} className="bg-slate-700 px-2 py-1 rounded border border-slate-600 w-full text-white" placeholder="SteamID" /> : <span className="font-mono text-sm">{steamID}</span>}
                                                            </td>
                                                            <td className="py-3 px-4 text-slate-400 text-sm">{lastPromoted}</td>
                                                            {isAuthenticated && (
                                                                <td className="py-3 px-4">
                                                                    <div className="flex items-center justify-center gap-2 flex-wrap">
                                                                        {isEditing ? (
                                                                            <>
                                                                                <button onClick={() => saveEdit(record.id)} disabled={loading} className="bg-green-600 hover:bg-green-700 px-3 py-1 rounded inline-flex items-center gap-1 transition disabled:opacity-50"><Save />Save</button>
                                                                                <button onClick={cancelEdit} className="bg-slate-600 hover:bg-slate-700 px-3 py-1 rounded inline-flex items-center gap-1 transition"><X />Cancel</button>
                                                                            </>
                                                                        ) : (
                                                                            <>
                                                                                {userCanPromote && currentIndex < RANKS.length - 1 && <button onClick={() => promoteUser(record.id, currentRank, name)} disabled={loading} className="bg-green-600 hover:bg-green-700 px-3 py-1 rounded inline-flex items-center gap-1 transition disabled:opacity-50"><ChevronUp />Promote</button>}
                                                                                {userCanDemote && currentIndex > 0 && <button onClick={() => demoteUser(record.id, currentRank, name)} disabled={loading} className="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded inline-flex items-center gap-1 transition disabled:opacity-50"><ChevronDown />Demote</button>}
                                                                                {userCanEdit && <button onClick={() => startEdit(record)} disabled={loading} className="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded inline-flex items-center gap-1 transition disabled:opacity-50"><Edit2 />Edit</button>}
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                            )}
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<RosterApp />);
    </script>
</body>
</html>
